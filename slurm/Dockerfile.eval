FROM vllm/vllm-openai:latest

# Configure project dir
ARG PROJECT_DIR=/workspace
ENV PROJECT_DIR="${PROJECT_DIR}"

# Set working directory
WORKDIR ${PROJECT_DIR}

# Install git
# Install system deps
RUN apt-get update && apt-get install -y \
    git \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Install uv for better package management
RUN curl -LsSf https://astral.sh/uv/install.sh | sh
ENV PATH="/root/.local/bin:${PATH}"

# Pin commit
ARG LMMS_EVAL_COMMIT=69e52879479f273833fe439b58c7e002d27a93aa

# Download LMM Eval
RUN git clone https://github.com/EvolvingLMMs-Lab/lmms-eval.git \
    && cd lmms-eval \
    && echo "decord" > exclude.txt \
    && git checkout ${LMMS_EVAL_COMMIT} \
    && uv pip install . --exclude exclude.txt --system

# Caches inside mounted directory
ENV HF_HOME="${PROJECT_DIR}/.hf"

ENTRYPOINT ["/bin/bash"]
CMD ["-l"]
